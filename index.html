<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>AniMedia Channels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: sans-serif; }
    .container { max-width: 400px; margin: auto; padding: 20px; }
    input, button {
      width: 100%; margin: 6px 0; padding: 10px;
      border-radius: 5px; border: none;
    }
    button { background: crimson; color: #fff; cursor: pointer; }
    .channel {
      background: #111; padding: 10px; margin: 5px 0;
      display: flex; align-items: center; border-radius: 5px;
      cursor: pointer;
    }
    .channel img {
      width: 40px; height: 40px; object-fit: cover;
      border-radius: 50%; margin-right: 10px;
    }
    .post {
      background: #111; padding: 10px; margin: 10px 0;
      border-radius: 5px;
    }
    .post img {
      max-width: 100%; margin-top: 10px;
    }
    .delete-btn {
      background: darkred; margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container" id="auth">
    <h2>AniMedia</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <input id="username" placeholder="Username (только при регистрации)">
    <button onclick="login()">Войти</button>
    <button onclick="register()">Регистрация</button>
  </div>

  <div class="container" id="app" style="display:none;">
    <h3>Привет, <span id="user-email"></span></h3>
    <button onclick="logout()">Выйти</button>
    <div id="channel-section">
      <button onclick="createChannelPrompt()">Создать канал</button>
      <button id="my-channel-btn" style="display:none;" onclick="enterChannel(myChannelId)">Мой канал</button>
    </div>
    <h4>Каналы:</h4>
    <div id="channel-list"></div>
  </div>

  <div class="container" id="channel-page" style="display:none;">
    <div style="text-align:center">
      <img id="channel-avatar" style="width:100px;height:100px;border-radius:50%;object-fit:cover"><br>
      <h3 id="channel-title"></h3>
      <p><span id="sub-count"></span> подписчиков</p>
      <button id="sub-btn" onclick="subscribe()">Подписаться</button>
      <button id="delete-channel-btn" class="delete-btn" onclick="deleteChannel()" style="display:none;">Удалить канал</button>
    </div>
    <div id="post-form" style="display:none;">
      <input id="post-text" placeholder="Текст поста">
      <input id="post-img" placeholder="Ссылка на изображение (необязательно)">
      <button onclick="sendPost()">Опубликовать</button>
    </div>
    <div id="post-list"></div>
    <button onclick="back()">Назад</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBpYjMmOiSSoItRuS9guy2c5KSH9y5DBmc",
      authDomain: "network-my.firebaseapp.com",
      projectId: "network-my",
      appId: "1:300961970076:web:08142c2382a3fb8e38fa59"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const authBox = document.getElementById("auth");
    const appBox = document.getElementById("app");
    const email = document.getElementById("email");
    const pass = document.getElementById("pass");
    const username = document.getElementById("username");
    const userEmail = document.getElementById("user-email");
    const channelList = document.getElementById("channel-list");
    const myChannelBtn = document.getElementById("my-channel-btn");
    const channelPage = document.getElementById("channel-page");
    const postForm = document.getElementById("post-form");
    const postList = document.getElementById("post-list");
    const deleteChannelBtn = document.getElementById("delete-channel-btn");

    let currentUserId = null;
    let myChannelId = null;
    let currentChannel = null;
    let currentChannelOwner = null;

    function register() {
      auth.createUserWithEmailAndPassword(email.value, pass.value)
        .then(cred => {
          db.collection("users").doc(cred.user.uid).set({
            email: email.value,
            username: username.value
          });
        }).catch(e => alert(e.message));
    }

    function login() {
      auth.signInWithEmailAndPassword(email.value, pass.value)
        .catch(e => alert(e.message));
    }

    function logout() {
      auth.signOut();
    }

    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUserId = user.uid;
        authBox.style.display = "none";
        appBox.style.display = "block";
        userEmail.textContent = user.email;

        const channelSnap = await db.collection("channels").where("owner", "==", currentUserId).get();
        if (!channelSnap.empty) {
          myChannelId = channelSnap.docs[0].id;
          myChannelBtn.style.display = "block";
        }

        loadChannels();
      } else {
        authBox.style.display = "block";
        appBox.style.display = "none";
        channelPage.style.display = "none";
        myChannelId = null;
      }
    });

    function createChannelPrompt() {
      const name = prompt("Название канала:");
      const avatar = prompt("Ссылка на аватарку (необязательно):") || "";
      if (name) {
        db.collection("channels").add({
          name,
          avatar,
          owner: currentUserId,
          subscribers: []
        }).then(doc => {
          myChannelId = doc.id;
          myChannelBtn.style.display = "block";
          loadChannels();
        });
      }
    }

    function loadChannels() {
      channelList.innerHTML = "";
      db.collection("channels").get().then(snap => {
        snap.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "channel";
          div.onclick = () => enterChannel(doc.id);
          div.innerHTML = `<img src="${data.avatar || 'https://via.placeholder.com/40'}"><div>${data.name}</div>`;
          channelList.appendChild(div);
        });
      });
    }

    function enterChannel(id) {
      appBox.style.display = "none";
      channelPage.style.display = "block";
      currentChannel = id;

      db.collection("channels").doc(id).get().then(doc => {
        const data = doc.data();
        document.getElementById("channel-avatar").src = data.avatar || 'https://via.placeholder.com/100';
        document.getElementById("channel-title").textContent = data.name;
        document.getElementById("sub-count").textContent = data.subscribers.length;
        currentChannelOwner = data.owner;

        if (currentUserId === data.owner) {
          postForm.style.display = "block";
          deleteChannelBtn.style.display = "block";
          document.getElementById("sub-btn").style.display = "none";
        } else {
          postForm.style.display = "none";
          deleteChannelBtn.style.display = "none";
          document.getElementById("sub-btn").style.display = "block";
        }

        loadPosts();
      });
    }

    function subscribe() {
      db.collection("channels").doc(currentChannel).update({
        subscribers: firebase.firestore.FieldValue.arrayUnion(currentUserId)
      }).then(() => alert("Вы подписались!"));
    }

    function sendPost() {
      const text = document.getElementById("post-text").value;
      const img = document.getElementById("post-img").value;
      if (text) {
        db.collection("channels").doc(currentChannel).collection("posts").add({
          text, img, created: Date.now()
        }).then(() => {
          document.getElementById("post-text").value = "";
          document.getElementById("post-img").value = "";
          loadPosts();
        });
      }
    }

    function loadPosts() {
      postList.innerHTML = "";
      db.collection("channels").doc(currentChannel).collection("posts").orderBy("created", "desc").get().then(snap => {
        snap.forEach(doc => {
          const data = doc.data();
          const div = document.createElement("div");
          div.className = "post";
          div.innerHTML = `<div>${data.text}</div>${data.img ? `<img src="${data.img}">` : ""}`;
          if (currentUserId === currentChannelOwner) {
            const del = document.createElement("button");
            del.className = "delete-btn";
            del.textContent = "Удалить пост";
            del.onclick = () => {
              db.collection("channels").doc(currentChannel).collection("posts").doc(doc.id).delete().then(loadPosts);
            };
            div.appendChild(del);
          }
          postList.appendChild(div);
        });
      });
    }

    function deleteChannel() {
      if (confirm("Удалить канал и все посты?")) {
        db.collection("channels").doc(currentChannel).collection("posts").get().then(snap => {
          const batch = db.batch();
          snap.forEach(doc => batch.delete(doc.ref));
          batch.commit().then(() => {
            db.collection("channels").doc(currentChannel).delete().then(() => {
              back();
              loadChannels();
              alert("Канал удалён");
            });
          });
        });
      }
    }

    function back() {
      channelPage.style.display = "none";
      appBox.style.display = "block";
    }
  </script>
</body>
</html>
